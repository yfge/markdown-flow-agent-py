name: Release

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install commitizen build twine pre-commit ruff mypy

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Install pre-commit hooks
        run: |
          # Skip pre-commit installation during local act testing
          if [[ "${ACT:-false}" == "true" ]]; then
            echo "Skipping pre-commit setup in act environment"
            git config --global init.templateDir ""
          else
            pre-commit install
          fi

      - name: Check branch protection status
        id: branch-protection
        run: |
          # Check if we can push directly to main
          if git push --dry-run origin main 2>/dev/null; then
            echo "can_push_directly=true" >> $GITHUB_OUTPUT
            echo "Branch allows direct push"
          else
            echo "can_push_directly=false" >> $GITHUB_OUTPUT
            echo "Branch is protected, will need special handling"
          fi

      - name: Bump version automatically
        id: bump-version
        run: |
          # Git-tag-based versioning: Version is determined entirely by git tags
          # No pyproject.toml version updates needed - everything is tag-driven

          # Check if there are commits that warrant a version bump
          echo "ðŸ” Checking for conventional commits that warrant version bump..."
          echo "ðŸ“‹ Current commitizen config:"
          cz info || echo "âš ï¸ Commitizen info failed"

          echo "ðŸ“Š Current git status:"
          git status --porcelain

          echo "ðŸ·ï¸ Current tags:"
          git tag -l --sort=-version:refname | head -5

          echo "ðŸ“ Recent commits:"
          git log --oneline -5

          # Try commitizen dry-run with error handling
          if DRY_RUN_OUTPUT=$(cz bump --dry-run 2>&1); then
            echo "ðŸ§ª Commitizen dry-run output:"
            echo "$DRY_RUN_OUTPUT"
          else
            echo "âš ï¸ Commitizen dry-run failed with exit code $?, trying alternative detection..."
            DRY_RUN_OUTPUT=$(cz bump --dry-run 2>&1 || true)
            echo "ðŸ§ª Commitizen dry-run output (with errors):"
            echo "$DRY_RUN_OUTPUT"
          fi

          if echo "$DRY_RUN_OUTPUT" | grep -q "bump: version"; then
            echo "bump_needed=true" >> $GITHUB_OUTPUT
            echo "Version bump detected based on conventional commits"

            # Get the new version that commitizen would create based on conventional commits
            NEW_VERSION=$(echo "$DRY_RUN_OUTPUT" | grep "bump: version" | sed 's/.*â†’ //')
            echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "New version will be: $NEW_VERSION"

            # Generate changelog content from last tag to current commits
            CHANGELOG_CONTENT=$(cz changelog --unreleased-version=$NEW_VERSION --dry-run 2>/dev/null || echo "Changelog generation failed")
            echo "changelog_content<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            # Create ONLY git tag - no file modifications needed
            # All version info comes from git tags via dynamic version detection
            echo "Creating git tag..."

            # Try commitizen bump with error handling
            if ! cz bump --yes; then
              echo "âš ï¸ Commitizen bump failed, trying manual tag creation..."

              # Manual tag creation as fallback
              if git tag -l | grep -q "^v$NEW_VERSION$"; then
                echo "âš ï¸ Tag v$NEW_VERSION already exists, skipping tag creation"
              else
                git tag "v$NEW_VERSION" -m "bump: version $(git describe --tags --abbrev=0 2>/dev/null || echo '0.0.0') â†’ $NEW_VERSION"
                echo "âœ… Manual tag created: v$NEW_VERSION"
              fi
            else
              echo "âœ… Commitizen tag created successfully"
            fi

            # Push based on branch protection status
            if [ "${{ steps.branch-protection.outputs.can_push_directly }}" = "true" ]; then
              echo "Pushing directly to main branch..."
              git push origin main --follow-tags
            else
              echo "Branch is protected, using alternative push strategy..."
              # Try with different authentication methods
              git push origin main --follow-tags || {
                echo "Standard push failed, trying with force-with-lease..."
                git push origin main --follow-tags --force-with-lease || {
                  echo "All push attempts failed. This might be due to branch protection rules."
                  echo "Please check repository settings or use a Personal Access Token (PAT_TOKEN)."
                  echo "You can also temporarily disable branch protection for releases."
                  exit 1
                }
              }
            fi
          else
            echo "bump_needed=false" >> $GITHUB_OUTPUT
            echo "No version bump needed based on commit messages"
          fi

      - name: Display changelog content
        if: steps.bump-version.outputs.bump_needed == 'true'
        run: |
          echo "Generated changelog content:"
          echo "${{ steps.bump-version.outputs.changelog_content }}"

      - name: Get version
        id: version
        run: |
          VERSION=$(python -c "import markdown_flow; print(markdown_flow.__version__)")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

      - name: Check if tag exists
        id: check-tag
        run: |
          if git tag -l "${{ steps.version.outputs.tag }}" | grep -q .; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Build package
        if: steps.bump-version.outputs.bump_needed == 'true' || steps.check-tag.outputs.exists == 'false'
        run: |
          python -m build

      - name: Publish to PyPI
        if: steps.bump-version.outputs.bump_needed == 'true' || steps.check-tag.outputs.exists == 'false'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_TOKEN }}
          skip-existing: true

      - name: Create GitHub Release
        if: steps.bump-version.outputs.bump_needed == 'true' || steps.check-tag.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body: |
            ${{ steps.bump-version.outputs.changelog_content }}

            ## Installation
            ```bash
            pip install markdown-flow==${{ steps.version.outputs.version }}
            ```

            ## What's Changed
            This release includes the following changes:
            - Automated version management with Commitizen
            - Enhanced GitHub Actions workflow for releases
            - Improved branch protection handling
            - Streamlined changelog generation
          files: |
            dist/*
          draft: false
          prerelease: false
